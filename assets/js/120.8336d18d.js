(window.webpackJsonp=window.webpackJsonp||[]).push([[120],{417:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"fail2ban-教程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fail2ban-教程"}},[s._v("#")]),s._v(" Fail2Ban 教程")]),s._v(" "),a("blockquote",[a("p",[s._v("作者："),a("a",{attrs:{href:"https://wangdoc.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("来自网道项目"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("本站地址："),a("a",{attrs:{href:"http://springsongs.cn",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://springsongs.cn"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),a("p",[s._v("Fail2Ban 是一个 Linux 系统的应用软件，用来防止系统入侵，主要是防止暴力破解系统密码。它是用 Python 开发的。")]),s._v(" "),a("p",[s._v("它主要通过监控日志文件（比如"),a("code",[s._v("/var/log/auth.log")]),s._v("、"),a("code",[s._v("/var/log/apache/access.log")]),s._v("等）来生效。一旦发现恶意攻击的登录请求，它会封锁对方的 IP 地址，使得对方无法再发起请求。")]),s._v(" "),a("p",[s._v("Fail2Ban 可以防止有人反复尝试 SSH 密码登录，但是如果 SSH 采用的是密钥登录，禁止了密码登录，就不需要 Fail2Ban 来保护。")]),s._v(" "),a("p",[s._v("Fail2Ban 的安装命令如下。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ubuntu & Debian")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" fail2ban\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Fedora")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" epel-release\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" fail2ban\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Centos & Red hat")]),s._v("\n$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" fail2ban\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("安装后，使用下面的命令查看 Fail2Ban 的状态。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ systemctl status fail2ban.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果没有启动，就启动 Fail2Ban。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start fail2ban\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("重新启动 Fail2Ban。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart fail2ban\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("设置 Fail2Ban 重启后自动运行。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" fail2ban\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"fail2ban-client"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fail2ban-client"}},[s._v("#")]),s._v(" fail2ban-client")]),s._v(" "),a("p",[s._v("Fail2Ban 自带一个客户端 fail2ban-client，用来操作 Fail2Ban。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ fail2ban-client\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("上面的命令会输出 fail2ban-client 所有的用法。")]),s._v(" "),a("p",[s._v("下面的命令查看激活的监控目标。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ fail2ban-client status\n\nStatus\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Number of jail:\t"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n`- Jail list:\tsshd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("下面的命令查看某个监控目标（这里是 sshd）的运行情况。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" fail2ban-client status sshd\n\nStatus "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the jail: sshd\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Filter\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Currently failed: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Total failed:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("- Journal matches:  "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("_SYSTEMD_UNIT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sshd.service + "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("_COMM")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sshd\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("- Actions\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Currently banned: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("- Total banned:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n   `- Banned IP list:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("下面的命令输出一个简要的版本，包括所有监控目标被封的 IP 地址。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" fail2ban-client banned\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sshd'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.100.50'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'apache-auth'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("下面的命令可以解封某个 IP 地址。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" fail2ban-client "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" sshd unbanip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.69\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),a("h3",{attrs:{id:"主配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主配置文件"}},[s._v("#")]),s._v(" 主配置文件")]),s._v(" "),a("p",[s._v("Fail2Ban 主配置文件是在"),a("code",[s._v("/etc/fail2ban/fail2ban.conf")]),s._v("，可以新建一份副本"),a("code",[s._v("/etc/fail2ban/fail2ban.local")]),s._v("，修改都针对副本。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/fail2ban/fail2ban.conf /etc/fail2ban/fail2ban.local\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("下面是设置 Fail2Ban 的日志位置。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Definition"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlogtarget "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /var/log/fail2ban/fail2ban.log\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改配置以后，需要重新启动"),a("code",[s._v("fail2ban.service")]),s._v("，让其生效。")]),s._v(" "),a("h3",{attrs:{id:"封禁配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#封禁配置"}},[s._v("#")]),s._v(" 封禁配置")]),s._v(" "),a("p",[s._v("Fail2Ban 封禁行为的配置文件是"),a("code",[s._v("/etc/fail2ban/jail.conf")]),s._v("。为了便于修改，可以把它复制一份"),a("code",[s._v("/etc/fail2ban/jail.local")]),s._v("，后面的修改都针对"),a("code",[s._v("jail.local")]),s._v("这个文件。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/fail2ban/jail.conf /etc/fail2ban/jail.local\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("你也可以在目录"),a("code",[s._v("/etc/fail2ban/jail.d")]),s._v("里面，新建单独的子配置文件，比如"),a("code",[s._v("/etc/fail2ban/jail.d/sshd.local")]),s._v("。")]),s._v(" "),a("p",[s._v("同样地，修改配置以后，需要重新启动"),a("code",[s._v("fail2ban.service")]),s._v("，让其生效。")]),s._v(" "),a("p",[s._v("配置文件里面，"),a("code",[s._v("[DEFAULT]")]),s._v("标题行表示对于所有封禁目标生效。举例来说，如果封禁时间修改为1天，"),a("code",[s._v("/etc/fail2ban/jail.local")]),s._v("里面可以写成：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nbantime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 1d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果某人被封时，对站长发送邮件通知，可以如下设置。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ndestemail "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" yourname@example.com\nsender "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" yourname@example.com\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to ban & send an e-mail with whois report to the destemail.")]),s._v("\naction "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action_mw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# same as action_mw but also send relevant log lines")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#action = %(action_mwl)s")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("如果配置写在其他标题行下，就表示只对该封禁目标生效，比如写在"),a("code",[s._v("[sshd]")]),s._v("下面，就表示只对 sshd 生效。")]),s._v(" "),a("p",[s._v("默认情况下，Fail2Ban 对各种服务都是关闭的，如果要针对某一项服务开启，需要在配置文件里面声明。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sshd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nenabled "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("上面声明表示，Fail2Ban 对 sshd 开启。")]),s._v(" "),a("h3",{attrs:{id:"配置项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置项"}},[s._v("#")]),s._v(" 配置项")]),s._v(" "),a("p",[s._v("下面是配置文件"),a("code",[s._v("jail.local")]),s._v("的配置项含义，所有配置项的格式都是"),a("code",[s._v("key=value")]),s._v("。")]),s._v(" "),a("p",[s._v("（1）bantime")]),s._v(" "),a("p",[s._v("封禁的时间长度，单位"),a("code",[s._v("m")]),s._v("表示分钟，"),a("code",[s._v("d")]),s._v("表示天，如果不写单位，则表示秒。Fail2Ban 默认封禁10分钟（10m 或 600）。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nbantime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 10m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("（2）findtime")]),s._v(" "),a("p",[s._v("登录失败计算的时间长度，单位"),a("code",[s._v("m")]),s._v("表示分钟，"),a("code",[s._v("d")]),s._v("表示天，如果不写单位，则表示秒。Fail2Ban 默认封禁 10 分钟内登录 5 次失败的客户端。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nfindtime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 10m\nmaxretry "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("（3）maxretry")]),s._v(" "),a("p",[s._v("尝试登录的最大失败次数。")]),s._v(" "),a("p",[s._v("（4）destemail")]),s._v(" "),a("p",[s._v("接受通知的邮件地址。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ndestemail "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" root@localhost\nsender "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("fq-hostname"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nmta "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sendmail")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("（5）sendername")]),s._v(" "),a("p",[s._v("通知邮件的“发件人”字段的值。")]),s._v(" "),a("p",[s._v("（6）mta")]),s._v(" "),a("p",[s._v("发送邮件的邮件服务，默认是"),a("code",[s._v("sendmail")]),s._v("。")]),s._v(" "),a("p",[s._v("（7）action")]),s._v(" "),a("p",[s._v("封禁时采取的动作。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("DEFAULT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\naction "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("action_"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("上面的"),a("code",[s._v("action_")]),s._v("是默认动作，表示拒绝封禁对象的流量，直到封禁期结束。")]),s._v(" "),a("p",[s._v("下面是 Fail2Ban 提供的一些其他动作。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ban & send an e-mail with whois report to the destemail.")]),s._v("\naction_mw "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s\n            %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s-whois"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(sender)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dest")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(destemail)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(protocol)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("chain")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(chain)s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ban & send an e-mail with whois report and relevant log lines")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to the destemail.")]),s._v("\naction_mwl "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s\n             %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s-whois-lines"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(sender)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dest")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(destemail)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(logpath)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("chain")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(chain)s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# See the IMPORTANT note in action.d/xarf-login-attack for when to use this action")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ban & send a xarf e-mail to abuse contact of IP address and include relevant log lines")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to the destemail.")]),s._v("\naction_xarf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("action_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s\n             xarf-login-attack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sender")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(sender)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(logpath)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(port)s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ban IP on CloudFlare & send an e-mail with whois report and relevant log lines")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to the destemail.")]),s._v("\naction_cf_mwl "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cloudflare"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cfuser"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(cfemail)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cftoken")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(cfapikey)s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s-whois-lines"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(sender)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dest")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(destemail)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("logpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(logpath)s"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("chain")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(chain)s"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("（8）ignoreip")]),s._v(" "),a("p",[s._v("Fail2Ban 可以忽视的可信 IP 地址。多个 IP 地址之间使用空格分隔。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ignoreip "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.10 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.20\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("（9）port")]),s._v(" "),a("p",[s._v("指定要监控的端口。可以设为任何端口号或服务名称，比如"),a("code",[s._v("ssh")]),s._v("、"),a("code",[s._v("22")]),s._v("、"),a("code",[s._v("2200")]),s._v("等。")]),s._v(" "),a("h3",{attrs:{id:"ssh-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-配置"}},[s._v("#")]),s._v(" ssh 配置")]),s._v(" "),a("p",[s._v("下面是 sshd 的设置范例。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sshd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nenabled   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v("\nfilter    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sshd\nbanaction "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" iptables\nbackend   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" systemd\nmaxretry  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\nfindtime  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 1d\nbantime   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 2w\nignoreip  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("首先需要注意，为了让 Fail2Ban 能够完整发挥作用，最好在"),a("code",[s._v("/etc/ssh/sshd_config")]),s._v("里面设置"),a("code",[s._v("LogLevel VERBOSE")]),s._v("，保证日志有足够的信息。")])])}),[],!1,null,null,null);a.default=e.exports}}]);